# C++ Trading Engine (Lock-Free + Matching System)

## Overview
–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π **–ø—Ä–æ—Ç–æ—Ç–∏–ø –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –±–∏—Ä–∂–µ–≤–æ–≥–æ Matching Engine**, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ C++20.  
–û–Ω –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º:
- –æ–±—Ä–∞–±–æ—Ç–∫—É Limit –∏ Market –æ—Ä–¥–µ—Ä–æ–≤;
- –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É OrderBook —Å FIFO –ª–æ–≥–∏–∫–æ–π;
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ lock-free –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –æ—Ä–¥–µ—Ä–æ–≤ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏;
- batch-–æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏;
- —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Client Thread ‚îÇ --->  ‚îÇ Lock-Free Queue (SPSC) ‚îÇ --->  ‚îÇ Matching Engine ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ   ‚îî‚îÄ> OrderBook ‚îÇ
                                                         ‚îÇ   ‚îî‚îÄ> Logger    ‚îÇ
                                                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

1. **Producers (–∫–ª–∏–µ–Ω—Ç—ã)** —Å–æ–∑–¥–∞—é—Ç –æ—Ä–¥–µ—Ä–∞ –∏ –ø–æ–º–µ—â–∞—é—Ç –∏—Ö –≤ lock-free –æ—á–µ—Ä–µ–¥—å.  
2. **MatchingEngine** —á–∏—Ç–∞–µ—Ç –æ—Ä–¥–µ—Ä–∞ –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `OrderBook::processOrder()`.  
3. **OrderBook** –∏—â–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (matching) –º–µ–∂–¥—É –æ—Ä–¥–µ—Ä–∞–º–∏ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å–¥–µ–ª–∫–∏ (trades).  
4. **Logger** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ —Å–¥–µ–ª–∫–∏ –≤ `logs/trading.log`.  
5. **Python-—Å–∫—Ä–∏–ø—Ç** (`analyze_trades.py`) —Å—Ç—Ä–æ–∏—Ç –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ —Å–¥–µ–ª–∫–∞–º.

---

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ú–æ–¥—É–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|-----------|
| **Order** | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–∞ (ID, —Ç–∏–ø, —Å—Ç–æ—Ä–æ–Ω–∞, —Ü–µ–Ω–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ) |
| **Trade** | –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–≤ (–ø–æ–∫—É–ø–∞—Ç–µ–ª—å, –ø—Ä–æ–¥–∞–≤–µ—Ü, —Ü–µ–Ω–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –≤—Ä–µ–º—è) |
| **OrderBook** | –•—Ä–∞–Ω–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞, –∏—Å–ø–æ–ª–Ω—è–µ—Ç —Å–¥–µ–ª–∫–∏, —Ä–µ–∞–ª–∏–∑—É–µ—Ç FIFO –∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—É—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å |
| **MatchingEngine** | –£–ø—Ä–∞–≤–ª—è–µ—Ç –æ—á–µ—Ä–µ–¥—å—é, –≤—ã–∑—ã–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ä–¥–µ—Ä–æ–≤, –ª–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã |
| **SPSCQueue** | Lock-free –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏ |
| **Logger** | –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π |
| **Metrics** | –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: latency, throughput, depth, executed trades |
| **analyze_trades.py** | –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö |

---

## –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞ —Å–¥–µ–ª–æ–∫

```
[12:45:00] TRADE 102->87 qty=10 price=100.0
[12:45:01] TRADE 103->88 qty=5  price=99.8
[12:45:02] TRADE 104->89 qty=8  price=100.2
```

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (Performance Metrics)

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|-----------|
| **Throughput** | ~150 000 –æ—Ä–¥–µ—Ä–æ–≤/—Å–µ–∫ |
| **Average latency** | ~45 ¬µs |
| **Queue depth (avg)** | 64 |
| **Executed trades** | >10 000 –≤ —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–µ |
| **Memory footprint** | <50 MB |
| **CPU load (4 threads)** | 40‚Äì60% |

---

## –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
- **Google Benchmark** ‚Äî –∏–∑–º–µ—Ä–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —è–¥—Ä–∞;
- **perf (Linux)** ‚Äî –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ CPU-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏ –∫—ç—à-–ø—Ä–æ–º–∞—Ö–æ–≤;
- **GoogleTest** ‚Äî –º–æ–¥—É–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ OrderBook –∏ MatchingEngine.

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | –≠—Ñ—Ñ–µ–∫—Ç |
|-------------|--------|
| –ü–µ—Ä–µ–≤–æ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ callback-—Å–æ–±—ã—Ç–∏—è | -15% latency |
| Batch-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ 100 –æ—Ä–¥–µ—Ä–æ–≤ | +22% throughput |
| Lock-free –æ—á–µ—Ä–µ–¥—å –≤–º–µ—Å—Ç–æ `std::mutex` | +40% —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–∏ 2 –ø–æ—Ç–æ–∫–∞—Ö |

---

## –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –°–∫—Ä–∏–ø—Ç `scripts/analyze_trades.py`
–°—á–∏—Ç—ã–≤–∞–µ—Ç `logs/trading.log`, –ø–∞—Ä—Å–∏—Ç —Å–¥–µ–ª–∫–∏ –∏ —Å—Ç—Ä–æ–∏—Ç –≥—Ä–∞—Ñ–∏–∫–∏:
- –¥–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω —Å–¥–µ–ª–æ–∫;
- –æ–±—ä—ë–º —Å–¥–µ–ª–æ–∫ (quantity);
- —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ latency.

---

## –ö–∞–∫ —Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å

```bash
git clone https://github.com/cheloveck322/trading_engine.git
cd trading_engine
mkdir build && cd build
cmake ..
make -j
./trading_engine
./benchmark_orderbook # –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫
./test_orderbook # –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç order_book
./test_engine # –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ matching_engine
```

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞:
- —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–∞–ø–∫–∞ `logs/`
- –≤ –Ω–µ–π –ø–æ—è–≤–ª—è–µ—Ç—Å—è `trading.log`
- –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª —á–µ—Ä–µ–∑ Python

---

## –ê–Ω–∞–ª–∏–∑ —Å–¥–µ–ª–æ–∫

```bash
cd scripts
python3 analyze_trades.py
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
- –ø–æ—è–≤—è—Ç—Å—è –¥–≤–∞ –≥—Ä–∞—Ñ–∏–∫–∞ (—Ü–µ–Ω—ã –∏ –æ–±—ä—ë–º—ã)
- –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `trades_parsed.csv` –¥–ª—è Excel

---

## –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **C++20 STL** ‚Äî –∞–ª–≥–æ—Ä–∏—Ç–º—ã –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã  
- **std::atomic** ‚Äî –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫  
- **Lock-free queue (SPSC)** ‚Äî –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–∞—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ—á–µ—Ä–µ–¥—å  
- **GoogleTest / Benchmark** ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ  
- **Python (matplotlib, pandas)** ‚Äî –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è  
- **CMake** ‚Äî —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞  
- **perf / valgrind** ‚Äî –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π  

---

## Roadmap (–ø–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ)

- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ MPMC –æ—á–µ—Ä–µ–¥–µ–π (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π)
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ REST API –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- [ ] –†–µ–∂–∏–º —Å–∏–º—É–ª—è—Ü–∏–∏ —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ (—Ä–µ–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫)
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ stop-limit –æ—Ä–¥–µ—Ä–æ–≤

---

## –ê–≤—Ç–æ—Ä
**Grigorev Vasily**  
GitHub: [github.com/cheloveck322](https://github.com/cheloveck322)

üìß –ö–æ–Ω—Ç–∞–∫—Ç: vasyagri2005@gmail.com